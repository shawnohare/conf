#!/usr/bin/env sh

DIR="${HOME}/conf"


_nix_build() {
    echo "switch: Building initial flake $1"
    nix --verbose --show-trace --extra-experimental-features "nix-command flakes" build "${DIR}/#$1"
}

# Wrapper for nixos-rebuild, darwin-rebuild, and home-manager which all
# expose the "switch" subcommand.
_switch() {
    cmd="$1"
    if [ -z "$2" ]; then
        attr="$DIR"
    else
        attr="$DIR/#$2"
    fi
    "${cmd}" --show-trace --verbose switch --flake "${attr}"
}

# rebuild the system configuration.
switch_system() {
    target="$1"
    if [ "$(uname -s)" = "Darwin" ]; then
        cmd="darwin-rebuild"
        if ! command -v "${cmd}" 1> /dev/null; then
            cd "${DIR}" || exit 1
            echo "switch: Did not detect darwin-rebuild command."
            _nix_build "darwinConfigurations.${target}.system"
            cmd="${DIR}/result/sw/bin/darwin-rebuild"
        fi
    else
        cmd="nixos-rebuild"
    fi

    _switch "${cmd}" "${target}"
    return 0
}

# Link configs not managed by home-manager
_stash() {
    _cmd="${DIR}/bin/stash/bin/stash"
    "${_cmd}" "${DIR}/etc/home" "${HOME}"
}

# rebuild the home-manager configuration
switch_home() {
    target="$1"
    if [ -z "${target}" ]; then
        target="$(whoami)"
    fi

    if ! command -v "home-manager" 1> /dev/null; then
        cd "${DIR}" || exit 1
        echo "switch: Building home manager configuration."
        _nix_build "homeConfigurations.${target}.activationPackage"
        ./result/activate
        echo "switch: Restart shell to ensure changes."
    else
        _switch "home-manager" "${target}"
    fi
    
    _stash

    return 0
}



case "$1" in
    --system|-s)
        cmd="switch_system"
        shift
        ;;
    --user|-u)
        cmd="switch_home"
        shift
        ;;
    --link|-l)
        cmd="_stash"
        shift
        ;;
    --help)
        echo "switch: Usage. switch [--user | --system] <flake attribute>"
        echo "By default, switch a home-manager configuration."
        echo "Examples: switch --system work, switch work"
        exit
        ;;
    *)
        cmd="switch_home"
        ;;
esac
"${cmd}" "$1"